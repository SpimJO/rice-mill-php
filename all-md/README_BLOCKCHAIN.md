# Blockchain Integration Guide

This document explains how the Hyperledger Fabric blockchain integration works in the Rice Mill system.

## Overview

The system now uses **Hyperledger Fabric** for blockchain logging instead of simple database hashing. All critical operations (user management, purchases, milling, inventory, etc.) are logged to the blockchain for immutability and auditability.

## Architecture

```
PHP System (Blockchain folder)
    ↓
blockchain_api.php (API Helper)
    ↓ HTTP Request
Backend API (Node.js/TypeScript)
    ↓
Hyperledger Fabric Service
    ↓
Hyperledger Fabric Network
```

## How It Works

### 1. PHP Files Integration

All PHP files that perform critical operations now use the `blockchain_api.php` helper:

- `login.php` - Logs user logins
- `usermanagement.php` - Logs user CRUD operations
- `buyingPalay.php` - Logs purchase transactions
- `milling.php` - Logs milling operations
- `products.php` - Logs inventory updates
- `reports.php` - Logs report generation

### 2. Fallback Mechanism

The system includes a **fallback mechanism**:
- **Primary**: Tries to log to Hyperledger Fabric blockchain
- **Fallback**: If blockchain is unavailable, logs to database (maintains backward compatibility)

This ensures the system continues to work even if the blockchain network is temporarily unavailable.

### 3. API Endpoints

The backend provides the following endpoints:

- `POST /api/v1/blockchain/log` - Create a blockchain log entry
- `GET /api/v1/blockchain/log/:id` - Get a specific log entry
- `GET /api/v1/blockchain/logs` - Get all log entries
- `GET /api/v1/blockchain/latest-hash` - Get the latest block hash
- `GET /api/v1/blockchain/verify` - Verify blockchain integrity
- `GET /api/v1/blockchain/health` - Check blockchain connection health

## Configuration

### Backend Configuration

1. Copy `.env.example` to `.env` in the `backend` folder
2. Configure Hyperledger Fabric settings:
   ```env
   FABRIC_CHANNEL_NAME=rice-mill-channel
   FABRIC_CHAINCODE_NAME=rice-mill-chaincode
   FABRIC_MSP_ID=Org1MSP
   FABRIC_CERT_PATH=./fabric-network/crypto-config/...
   FABRIC_KEY_PATH=./fabric-network/crypto-config/...
   ```

### PHP Configuration

Update `blockchain_api.php` or set environment variables:

```php
$BLOCKCHAIN_API_URL = 'http://localhost:3000/api/v1';
$BLOCKCHAIN_API_KEY = 'your_api_key_here';
```

Or use environment variables:
```bash
export BLOCKCHAIN_API_URL=http://localhost:3000/api/v1
export BLOCKCHAIN_API_KEY=your_api_key_here
```

## Usage Example

### In PHP Files

```php
<?php
include "db.php";
include "blockchain_api.php";

// Create a blockchain log
$result = createBlockchainLog(
    $user_id,
    "Add Purchase",
    $supplier,
    [
        "supplier" => $supplier,
        "quantity" => $quantity,
        "price" => $price
    ]
);

if ($result['success']) {
    echo "Logged to blockchain: " . $result['hash'];
} else {
    echo "Error: " . $result['error'];
}
```

### Using Fallback Function

```php
<?php
include "db.php";
include "blockchain_api.php";

// This function tries blockchain first, then falls back to database
addBlockchainLogWithFallback(
    $conn,
    $user_id,
    "Add Purchase",
    $supplier,
    $data
);
```

## Data Structure

Each blockchain log entry contains:

- `userId` - User ID performing the action
- `action` - Action type (e.g., "Add Purchase", "LOGIN_SUCCESS")
- `targetUser` - Target user or entity
- `data` - JSON data containing operation details
- `timestamp` - When the action occurred
- `previousHash` - Hash of the previous block
- `currentHash` - Hash of the current block (generated by blockchain)
- `txId` - Transaction ID from Hyperledger Fabric

## Benefits

1. **Immutability** - Once logged, records cannot be altered
2. **Auditability** - Complete transaction history
3. **Transparency** - All operations are traceable
4. **Security** - Cryptographic hashing ensures data integrity
5. **Distributed** - Data is replicated across network nodes

## Troubleshooting

### Blockchain API Not Available

If you see errors about the blockchain API:
1. Check if the backend server is running: `http://localhost:3000/api/v1/blockchain/health`
2. Verify API key is correct
3. Check network connectivity
4. The system will automatically fall back to database logging

### Certificate Errors

If you see certificate errors:
1. Verify certificate paths in `.env` are correct
2. Ensure certificates are in PEM format
3. Check file permissions
4. See `backend/HYPERLEDGER_SETUP.md` for detailed setup

### Connection Timeout

If requests timeout:
1. Check if Hyperledger Fabric network is running
2. Verify connection profile endpoints
3. Increase timeout in `blockchain_api.php` if needed

## Testing

### Test Blockchain Connection

```bash
curl http://localhost:3000/api/v1/blockchain/health
```

### Test Creating a Log

```bash
curl -X POST http://localhost:3000/api/v1/blockchain/log \
  -H "Content-Type: application/json" \
  -H "api-key: your_api_key_here" \
  -d '{
    "userId": "1",
    "action": "TEST_ACTION",
    "targetUser": "test",
    "data": {"test": "data"}
  }'
```

### Test Getting Logs

```bash
curl http://localhost:3000/api/v1/blockchain/logs \
  -H "api-key: your_api_key_here"
```

## Next Steps

1. **Set up Hyperledger Fabric network** - See `backend/HYPERLEDGER_SETUP.md`
2. **Deploy chaincode** - Implement the required chaincode functions
3. **Configure certificates** - Set up user certificates
4. **Test integration** - Verify all operations are logging correctly
5. **Monitor** - Check blockchain logs regularly for integrity

## Support

For issues or questions:
1. Check the setup documentation in `backend/HYPERLEDGER_SETUP.md`
2. Review error logs in the backend console
3. Check PHP error logs for API call issues
4. Verify Hyperledger Fabric network status

